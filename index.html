<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotoba Revision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-container {
            perspective: 1000px;
        }
        .flashcard {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border-radius: 1rem;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card-back {
            transform: rotateY(180deg);
            background-color: #f3f4f6;
        }
        .finish-animation {
            animation: fadeInScale 0.8s ease-in-out forwards;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .checkbox-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 9999px;
            background-color: #f0f4f8;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .checkbox-container:hover {
            background-color: #e2e8f0;
        }
        .checkbox-container.selected {
            background-color: #6366f1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #4338ca;
        }
        .checkbox-container.selected:hover {
            background-color: #4f46e5;
        }
        .checkbox-container input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .checkbox-container span {
            font-weight: 600;
            color: #4a5568;
            font-size: 1.25rem;
            transition: color 0.2s;
        }
        .checkbox-container.selected span {
            color: #ffffff;
        }
        #start-revision-btn:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- Main App Container -->
    <div id="app" class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-8 md:p-10 flex flex-col items-center text-center">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-600 mb-2">Kotoba Revision</h1>
        <p class="text-gray-500 mb-8">Choose your revision style to begin.</p>

        <!-- Lesson Selection Section -->
        <div id="lesson-selection" class="w-full space-y-4">
            <h2 class="text-xl font-bold mb-4">Select Lessons</h2>
            <div id="lesson-checkboxes" class="grid grid-cols-5 md:grid-cols-7 gap-4 justify-center">
                <!-- Lesson checkboxes will be dynamically added here -->
            </div>
            
            <div class="flex flex-col items-center mt-6">
                <button id="start-revision-btn" class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-indigo-600 transition-colors w-full" disabled>
                    Start Revision
                </button>
            </div>
        </div>

        <!-- Mode Selection Section -->
        <div id="mode-selection" class="w-full space-y-4 hidden relative">
            <h2 class="text-xl font-bold mb-4">Choose a Revision Mode</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <button id="manual-word-mode-btn" class="mode-btn bg-emerald-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-emerald-600 transition-colors">
                    Manual (Word First)
                </button>
                <button id="manual-meaning-mode-btn" class="mode-btn bg-rose-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-rose-600 transition-colors">
                    Manual (Meaning First)
                </button>
                <button id="timed-word-mode-btn" class="mode-btn bg-sky-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-sky-600 transition-colors">
                    Timed (Word First)
                </button>
                <button id="timed-meaning-mode-btn" class="mode-btn bg-purple-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-purple-600 transition-colors">
                    Timed (Meaning First)
                </button>
            </div>

            <!-- Customize Button is now centered and below the main mode buttons -->
            <button id="customize-btn" class="w-full mt-4 text-indigo-500 font-semibold py-2 px-4 rounded-full border border-indigo-500 hover:bg-indigo-50 transition-colors">
                Customize Timed Settings
            </button>
            
            <button id="back-to-lessons-btn" class="text-gray-500 font-medium hover:text-gray-700 transition-colors mt-4">
                ← Back to Lessons
            </button>
        </div>

        <!-- Timer Settings Section -->
        <div id="settings-screen" class="w-full space-y-4 hidden">
            <h2 class="text-xl font-bold text-gray-700">Customize Timed Mode</h2>
            <p class="text-gray-500 text-sm mb-4">Set the timers for your timed revision sessions.</p>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label for="flip-delay" class="block text-sm font-medium text-gray-600 mb-1">Flip Delay (seconds)</label>
                    <input type="number" id="flip-delay" value="3" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-full text-center focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex-1 w-full">
                    <label for="next-delay" class="block text-sm font-medium text-gray-600 mb-1">Next Card Delay (seconds)</label>
                    <input type="number" id="next-delay" value="2" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-full text-center focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <button id="back-from-settings-btn" class="text-gray-500 font-medium hover:text-gray-700 transition-colors mt-4">
                ← Back to Modes
            </button>
        </div>

        <!-- Flashcard & Revision Section -->
        <div id="revision-section" class="w-full hidden flex flex-col items-center">
            
            <!-- New Word Count Display -->
            <div class="mb-4 text-center">
                <p id="progress-display" class="text-xl font-bold text-indigo-600"></p>
                <p id="word-count-display" class="text-sm text-gray-500"></p>
            </div>

            <!-- The Flashcard -->
            <div class="card-container relative w-full max-w-sm h-56 mb-8">
                <div id="flashcard" class="flashcard">
                    <!-- Card Front -->
                    <div id="card-front" class="card-face">
                        <p id="card-front-text" class="text-2xl font-bold text-gray-700 mb-2"></p>
                    </div>
                    <!-- Card Back -->
                    <div id="card-back" class="card-face card-back">
                        <p id="card-back-text" class="text-2xl font-bold text-gray-700 mb-2"></p>
                    </div>
                </div>
            </div>

            <!-- Buttons for Revision -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="previous-word-btn" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-md hover:bg-gray-400 transition-colors">
                    Previous Word
                </button>
                <button id="pause-btn" class="flex-1 bg-yellow-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-yellow-600 transition-colors">
                    Pause
                </button>
                <button id="restart-btn" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-md hover:bg-gray-400 transition-colors">
                    Restart
                </button>
                <button id="next-word-btn" class="flex-1 bg-indigo-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-indigo-600 transition-colors">
                    Next Word
                </button>
            </div>
            <button id="back-from-revision-btn" class="text-gray-500 font-medium hover:text-gray-700 transition-colors mt-4">
                ← Back to Lessons
            </button>

            <!-- Status Messages & Timer -->
            <p id="timer-display" class="mt-2 font-medium text-sm text-gray-500"></p>
            <p id="status-message" class="mt-4 font-bold text-lg"></p>

        </div>

        <!-- Finish Screen -->
        <div id="finish-screen" class="w-full hidden flex flex-col items-center justify-center h-full text-center">
            <div class="finish-animation p-8 bg-white rounded-xl shadow-xl">
                <p id="finish-message" class="text-3xl font-extrabold text-green-600 mb-2">🎉 Well Done! 🎉</p>
                <p class="text-xl font-bold text-gray-700 mb-4">You've finished this set!</p>
                <p id="finish-timer" class="text-gray-500">Returning to lessons in 5 seconds...</p>
            </div>
        </div>

    </div>

    <script>
        const vocabularyData = {
            "Lesson 1": [
                { kanji: "おはようございます", hiragana: "おはようございます", meaning: "Good morning" },
                { kanji: "こんにちは", hiragana: "こんにちは", meaning: "Hello, Good afternoon" },
                { kanji: "こんばんは", hiragana: "こんばんは", meaning: "Good evening" },
                { kanji: "おやすみ", hiragana: "おやすみ", meaning: "Good night" },
                { kanji: "さようなら", hiragana: "さようなら", meaning: "Goodbye" },
                { kanji: "ありがとう", hiragana: "ありがとう", meaning: "Thank you" },
                { kanji: "すみません", hiragana: "すみません", meaning: "Excuse me, Sorry" },
                { kanji: "ごめんなさい", hiragana: "ごめんなさい", meaning: "I'm sorry" },
                { kanji: "いただきます", hiragana: "いただきます", meaning: "I humbly receive (before eating)" },
                { kanji: "ごちそうさまでした", hiragana: "ごちそうさまでした", meaning: "Thank you for the meal (after eating)" }
            ],
            "Lesson 2": [
                { kanji: "はい", hiragana: "はい", meaning: "Yes" },
                { kanji: "いいえ", hiragana: "いいえ", meaning: "No" },
                { kanji: "おなまえは？", hiragana: "おなまえは？", meaning: "What is your name?" },
                { kanji: "わたしは", hiragana: "わたしは", meaning: "I am..." },
                { kanji: "せんせい", hiragana: "せんせい", meaning: "Teacher" },
                { kanji: "がくせい", hiragana: "がくせい", meaning: "Student" },
                { kanji: "ともだち", hiragana: "ともだち", meaning: "Friend" },
                { kanji: "にほんご", hiragana: "にほんご", meaning: "Japanese language" },
                { kanji: "えいご", hiragana: "えいご", meaning: "English language" },
                { kanji: "しごと", hiragana: "しごと", meaning: "Work, job" }
            ],
            "Lesson 3": [
                { kanji: "おげんきですか？", hiragana: "おげんきですか？", meaning: "How are you?" },
                { kanji: "げんきです", hiragana: "げんきです", meaning: "I'm fine" },
                { kanji: "おいくつですか？", hiragana: "おいくつですか？", meaning: "How old are you?" },
                { kanji: "なんさいですか？", hiragana: "なんさいですか？", meaning: "How old are you?" },
                { kanji: "かぞく", hiragana: "かぞく", meaning: "Family" },
                { kanji: "おとうさん", hiragana: "おとうさん", meaning: "Father" },
                { kanji: "おかあさん", hiragana: "おかあさん", meaning: "Mother" },
                { kanji: "きょうだい", hiragana: "きょうだい", meaning: "Siblings" },
                { kanji: "おにいさん", hiragana: "おにいさん", meaning: "Older brother" },
                { kanji: "いもうと", hiragana: "いもうと", meaning: "Younger sister" }
            ],
            "Lesson 4": [
                { kanji: "学校", hiragana: "がっこう", meaning: "School" },
                { kanji: "学生", hiragana: "がくせい", meaning: "Student" },
                { kanji: "先生", hiragana: "せんせい", meaning: "Teacher" },
                { kanji: "本", hiragana: "ほん", meaning: "Book" },
                { kanji: "机", hiragana: "つくえ", meaning: "Desk" },
                { kanji: "椅子", hiragana: "いす", meaning: "Chair" },
                { kanji: "鉛筆", hiragana: "えんぴつ", meaning: "Pencil" },
                { kanji: "消しゴム", hiragana: "けしごむ", meaning: "Eraser" },
                { kanji: "かばん", hiragana: "かばん", meaning: "Bag" },
                { kanji: "ノート", hiragana: "ノート", meaning: "Notebook" }
            ],
            "Lesson 5": [
                { kanji: "食べる", hiragana: "たべる", meaning: "to eat" },
                { kanji: "飲む", hiragana: "のむ", meaning: "to drink" },
                { kanji: "買う", hiragana: "かう", meaning: "to buy" },
                { kanji: "見る", hiragana: "みる", meaning: "to see, to watch" },
                { kanji: "聞く", hiragana: "きく", meaning: "to listen, to hear" },
                { kanji: "書く", hiragana: "かく", meaning: "to write" },
                { kanji: "読む", hiragana: "よむ", meaning: "to read" },
                { kanji: "話す", hiragana: "はなす", meaning: "to speak" },
                { kanji: "行く", hiragana: "いく", meaning: "to go" },
                { kanji: "来る", hiragana: "くる", meaning: "to come" }
            ],
            "Lesson 6": [
                { kanji: "家", hiragana: "いえ", meaning: "House" },
                { kanji: "部屋", hiragana: "へや", meaning: "Room" },
                { kanji: "台所", hiragana: "だいどころ", meaning: "Kitchen" },
                { kanji: "風呂", hiragana: "ふろ", meaning: "Bath" },
                { kanji: "トイレ", hiragana: "トイレ", meaning: "Toilet" },
                { kanji: "ドア", hiragana: "ドア", meaning: "Door" },
                { kanji: "窓", hiragana: "まど", meaning: "Window" },
                { kanji: "電気", hiragana: "でんき", meaning: "Electricity, light" },
                { kanji: "冷蔵庫", hiragana: "れいぞうこ", meaning: "Refrigerator" },
                { kanji: "テレビ", hiragana: "テレビ", meaning: "Television" }
            ],
            "Lesson 7": [
                { kanji: "好き", hiragana: "すき", meaning: "Likeable" },
                { kanji: "嫌い", hiragana: "きらい", meaning: "Hateable" },
                { kanji: "上手", hiragana: "じょうず", meaning: "Good at" },
                { kanji: "下手", hiragana: "へた", meaning: "Bad at" },
                { kanji: "元気", hiragana: "げんき", meaning: "Healthy, cheerful" },
                { kanji: "暇", hiragana: "ひま", meaning: "Free time" },
                { kanji: "便利", hiragana: "べんり", meaning: "Convenient" },
                { kanji: "不便", hiragana: "ふべん", meaning: "Inconvenient" },
                { kanji: "賑やか", hiragana: "にぎやか", meaning: "Lively" },
                { kanji: "静か", hiragana: "しずか", meaning: "Quiet" }
            ],
            "Lesson 8": [
                { kanji: "高い", hiragana: "たかい", meaning: "Tall, expensive" },
                { kanji: "安い", hiragana: "やすい", meaning: "Cheap" },
                { kanji: "大きい", hiragana: "おおきい", meaning: "Big" },
                { kanji: "小さい", hiragana: "ちいさい", meaning: "Small" },
                { kanji: "新しい", hiragana: "あたらしい", meaning: "New" },
                { kanji: "古い", hiragana: "ふるい", meaning: "Old" },
                { kanji: "美味しい", hiragana: "おいしい", meaning: "Delicious" },
                { kanji: "不味い", hiragana: "まずい", meaning: "Bad-tasting" },
                { kanji: "暑い", hiragana: "あつい", meaning: "Hot (weather)" },
                { kanji: "寒い", hiragana: "さむい", meaning: "Cold (weather)" }
            ],
            "Lesson 9": [
                { kanji: "時", hiragana: "とき", meaning: "Time" },
                { kanji: "分", hiragana: "ふん", meaning: "Minute" },
                { kanji: "午前", hiragana: "ごぜん", meaning: "AM" },
                { kanji: "午後", hiragana: "ごご", meaning: "PM" },
                { kanji: "今", hiragana: "いま", meaning: "Now" },
                { kanji: "朝", hiragana: "あさ", meaning: "Morning" },
                { kanji: "昼", hiragana: "ひる", meaning: "Noon, daytime" },
                { kanji: "晩", hiragana: "ばん", meaning: "Evening" },
                { kanji: "夜", hiragana: "よる", meaning: "Night" },
                { kanji: "今日", hiragana: "きょう", meaning: "Today" }
            ],
            "Lesson 10": [
                { kanji: "日", hiragana: "にち", meaning: "Day" },
                { kanji: "週", hiragana: "しゅう", meaning: "Week" },
                { kanji: "月", hiragana: "げつ", meaning: "Month" },
                { kanji: "年", hiragana: "とし", meaning: "Year" },
                { kanji: "先週", hiragana: "せんしゅう", meaning: "Last week" },
                { kanji: "今週", hiragana: "こんしゅう", meaning: "This week" },
                { kanji: "来週", hiragana: "らいしゅう", meaning: "Next week" },
                { kanji: "先月", hiragana: "せんげつ", meaning: "Last month" },
                { kanji: "今月", hiragana: "こんげつ", meaning: "This month" },
                { kanji: "来月", hiragana: "らいげつ", meaning: "Next month" }
            ],
            "Lesson 11": [
                { kanji: "行く", hiragana: "いく", meaning: "To go" },
                { kanji: "来る", hiragana: "くる", meaning: "To come" },
                { kanji: "帰る", hiragana: "かえる", meaning: "To return" },
                { kanji: "食べる", hiragana: "たべる", meaning: "To eat" },
                { kanji: "飲む", hiragana: "のむ", meaning: "To drink" },
                { kanji: "寝る", hiragana: "ねる", meaning: "To sleep" },
                { kanji: "起きる", hiragana: "おきる", meaning: "To wake up" },
                { kanji: "見る", hiragana: "みる", meaning: "To see" },
                { kanji: "聞く", hiragana: "きく", meaning: "To listen" },
                { kanji: "話す", hiragana: "はなす", meaning: "To speak" }
            ],
            "Lesson 12": [
                { kanji: "山", hiragana: "やま", meaning: "Mountain" },
                { kanji: "川", hiragana: "かわ", meaning: "River" },
                { kanji: "海", hiragana: "うみ", meaning: "Sea, Ocean" },
                { kanji: "町", hiragana: "まち", meaning: "Town" },
                { kanji: "村", hiragana: "むら", meaning: "Village" },
                { kanji: "道", hiragana: "みち", meaning: "Road" },
                { kanji: "空", hiragana: "そら", meaning: "Sky" },
                { kanji: "天気", hiragana: "てんき", meaning: "Weather" },
                { kanji: "晴れ", hiragana: "はれ", meaning: "Sunny weather" },
                { kanji: "雨", hiragana: "あめ", meaning: "Rain" }
            ],
            "Lesson 13": [
                { kanji: "電話", hiragana: "でんわ", meaning: "Telephone" },
                { kanji: "手紙", hiragana: "てがみ", meaning: "Letter" },
                { kanji: "写真", hiragana: "しゃしん", meaning: "Photograph" },
                { kanji: "新聞", hiragana: "しんぶん", meaning: "Newspaper" },
                { kanji: "雑誌", hiragana: "ざっし", meaning: "Magazine" },
                { kanji: "辞書", hiragana: "じしょ", meaning: "Dictionary" },
                { kanji: "地図", hiragana: "ちず", meaning: "Map" },
                { kanji: "時計", hiragana: "とけい", meaning: "Clock, watch" },
                { kanji: "傘", hiragana: "かさ", meaning: "Umbrella" },
                { kanji: "鍵", hiragana: "かぎ", meaning: "Key" }
            ],
            "Lesson 14": [
                { kanji: "電車", hiragana: "でんしゃ", meaning: "Train" },
                { kanji: "バス", hiragana: "バス", meaning: "Bus" },
                { kanji: "飛行機", hiragana: "ひこうき", meaning: "Airplane" },
                { kanji: "車", hiragana: "くるま", meaning: "Car" },
                { kanji: "自転車", hiragana: "じてんしゃ", meaning: "Bicycle" },
                { kanji: "駅", hiragana: "えき", meaning: "Station" },
                { kanji: "空港", hiragana: "くうこう", meaning: "Airport" },
                { kanji: "バス停", hiragana: "バスてい", meaning: "Bus stop" },
                { kanji: "切符", hiragana: "きっぷ", meaning: "Ticket" },
                { kanji: "運賃", hiragana: "うんちん", meaning: "Fare" }
            ],
            "Lesson 15": [
                { kanji: "銀行", hiragana: "ぎんこう", meaning: "Bank" },
                { kanji: "郵便局", hiragana: "ゆうびんきょく", meaning: "Post office" },
                { kanji: "病院", hiragana: "びょういん", meaning: "Hospital" },
                { kanji: "図書館", hiragana: "としょかん", meaning: "Library" },
                { kanji: "美術館", hiragana: "びじゅつかん", meaning: "Art museum" },
                { kanji: "公園", hiragana: "こうえん", meaning: "Park" },
                { kanji: "店", hiragana: "みせ", meaning: "Store" },
                { kanji: "レストラン", hiragana: "レストラン", meaning: "Restaurant" },
                { kanji: "駅", hiragana: "えき", meaning: "Station" },
                { kanji: "ホテル", hiragana: "ホテル", meaning: "Hotel" }
            ],
            "Lesson 16": [
                { kanji: "お金", hiragana: "おかね", meaning: "Money" },
                { kanji: "円", hiragana: "えん", meaning: "Yen (Japanese currency)" },
                { kanji: "買い物", hiragana: "かいもの", meaning: "Shopping" },
                { kanji: "レシート", hiragana: "レシート", meaning: "Receipt" },
                { kanji: "お釣り", hiragana: "おつり", meaning: "Change (money)" },
                { kanji: "値段", hiragana: "ねだん", meaning: "Price" },
                { kanji: "セール", hiragana: "セール", meaning: "Sale" },
                { kanji: "クレジットカード", hiragana: "クレジットカード", meaning: "Credit card" },
                { kanji: "現金", hiragana: "げんきん", meaning: "Cash" },
                { kanji: "小銭", hiragana: "こぜに", meaning: "Small change" }
            ],
            "Lesson 17": [
                { kanji: "家族", hiragana: "かぞく", meaning: "Family" },
                { kanji: "両親", hiragana: "りょうしん", meaning: "Parents" },
                { kanji: "父", hiragana: "ちち", meaning: "Father (my own)" },
                { kanji: "母", hiragana: "はは", meaning: "Mother (my own)" },
                { kanji: "兄", hiragana: "あに", meaning: "Older brother (my own)" },
                { kanji: "姉", hiragana: "あね", meaning: "Older sister (my own)" },
                { kanji: "弟", hiragana: "おとうと", meaning: "Younger brother (my own)" },
                { kanji: "妹", hiragana: "いもうと", meaning: "Younger sister (my own)" },
                { kanji: "兄弟", hiragana: "きょうだい", meaning: "Siblings" },
                { kanji: "子供", hiragana: "こども", meaning: "Child" }
            ],
            "Lesson 18": [
                { kanji: "友達", hiragana: "ともだち", meaning: "Friend" },
                { kanji: "恋人", hiragana: "こいびと", meaning: "Lover, sweetheart" },
                { kanji: "結婚", hiragana: "けっこん", meaning: "Marriage" },
                { kanji: "誕生日", hiragana: "たんじょうび", meaning: "Birthday" },
                { kanji: "仕事", hiragana: "しごと", meaning: "Work" },
                { kanji: "勉強", hiragana: "べんきょう", meaning: "Study" },
                { kanji: "趣味", hiragana: "しゅみ", meaning: "Hobby" },
                { kanji: "スポーツ", hiragana: "スポーツ", meaning: "Sports" },
                { kanji: "音楽", hiragana: "おんがく", meaning: "Music" },
                { kanji: "映画", hiragana: "えいが", meaning: "Movie" }
            ],
            "Lesson 19": [
                { kanji: "食べ物", hiragana: "たべもの", meaning: "Food" },
                { kanji: "飲み物", hiragana: "のみもの", meaning: "Drink" },
                { kanji: "ご飯", hiragana: "ごはん", meaning: "Cooked rice, meal" },
                { kanji: "パン", hiragana: "パン", meaning: "Bread" },
                { kanji: "肉", hiragana: "にく", meaning: "Meat" },
                { kanji: "魚", hiragana: "さかな", meaning: "Fish" },
                { kanji: "野菜", hiragana: "やさい", meaning: "Vegetable" },
                { kanji: "果物", hiragana: "くだもの", meaning: "Fruit" },
                { kanji: "水", hiragana: "みず", meaning: "Water" },
                { kanji: "お茶", hiragana: "おちゃ", meaning: "Tea" }
            ],
            "Lesson 20": [
                { kanji: "日本語", hiragana: "にほんご", meaning: "Japanese language" },
                { kanji: "英語", hiragana: "えいご", meaning: "English language" },
                { kanji: "中国語", hiragana: "ちゅうごくご", meaning: "Chinese language" },
                { kanji: "韓国語", hiragana: "かんこくご", meaning: "Korean language" },
                { kanji: "話す", hiragana: "はなす", meaning: "To speak" },
                { kanji: "聞く", hiragana: "きく", meaning: "To listen" },
                { kanji: "読む", hiragana: "よむ", meaning: "To read" },
                { kanji: "書く", hiragana: "かく", meaning: "To write" },
                { kanji: "わかる", hiragana: "わかる", meaning: "To understand" },
                { kanji: "できる", hiragana: "できる", meaning: "Can do" }
            ],
            "Lesson 21": [
                { kanji: "上", hiragana: "うえ", meaning: "On, above" },
                { kanji: "下", hiragana: "した", meaning: "Under, below" },
                { kanji: "中", hiragana: "なか", meaning: "Inside" },
                { kanji: "外", hiragana: "そと", meaning: "Outside" },
                { kanji: "前", hiragana: "まえ", meaning: "In front of, before" },
                { kanji: "後ろ", hiragana: "うしろ", meaning: "Behind, back" },
                { kanji: "右", hiragana: "みぎ", meaning: "Right" },
                { kanji: "左", hiragana: "ひだり", meaning: "Left" },
                { kanji: "隣", hiragana: "となり", meaning: "Next to" },
                { kanji: "近く", hiragana: "ちかく", meaning: "Near" }
            ],
            "Lesson 22": [
                { kanji: "動く", hiragana: "うごく", meaning: "To move" },
                { kanji: "止まる", hiragana: "とまる", meaning: "To stop" },
                { kanji: "入る", hiragana: "はいる", meaning: "To enter" },
                { kanji: "出る", hiragana: "でる", meaning: "To exit" },
                { kanji: "開ける", hiragana: "あける", meaning: "To open" },
                { kanji: "閉める", hiragana: "しめる", meaning: "To close" },
                { kanji: "始まる", hiragana: "はじまる", meaning: "To begin" },
                { kanji: "終わる", hiragana: "おわる", meaning: "To end" },
                { kanji: "使う", hiragana: "つかう", meaning: "To use" },
                { kanji: "作る", hiragana: "つくる", meaning: "To make" }
            ],
            "Lesson 23": [
                { kanji: "聞きます", hiragana: "ききます", dictionary: "聞く", meaning: "to ask; to listen" },
                { kanji: "回します", hiragana: "まわします", dictionary: "回す", meaning: "to turn; to rotate" },
                { kanji: "引きます", hiragana: "ひきます", dictionary: "引く", meaning: "to pull; to draw" },
                { kanji: "変えます", hiragana: "かえます", dictionary: "変える", meaning: "to change; to exchange" },
                { kanji: "触ります", hiragana: "さわります", dictionary: "触る", meaning: "to touch (something)" },
                { kanji: "出ます", hiragana: "でます", dictionary: "出る", meaning: "to go out; to leave; to come out; to attend (depends on context)" },
                { kanji: "歩きます", hiragana: "あるきます", dictionary: "歩く", meaning: "to walk" },
                { kanji: "渡ります", hiragana: "わたります", dictionary: "渡る", meaning: "to cross (a bridge, road, etc.)" },
                { kanji: "曲がります", hiragana: "まがります", dictionary: "曲がる", meaning: "to turn (left/right)" },
                { kanji: "寂しい", hiragana: "さびしい", meaning: "lonely; lonesome" },
                { kanji: "お湯", hiragana: "おゆ", meaning: "hot water" },
                { kanji: "音", hiragana: "おと", meaning: "sound; noise" },
                { kanji: "サイズ", hiragana: "サイズ", meaning: "size" },
                { kanji: "故障", hiragana: "こしょう", meaning: "breakdown; failure (of a machine, car, etc.)" },
                { kanji: "道", hiragana: "みち", meaning: "street; road; way" },
                { kanji: "交差点", hiragana: "こうさてん", meaning: "intersection; crossing" },
                { kanji: "信号", hiragana: "しんごう", meaning: "traffic light; signal" },
                { kanji: "角", hiragana: "かど", meaning: "corner (of a street, building, etc.)" },
                { kanji: "橋", hiragana: "はし", meaning: "bridge" },
                { kanji: "駐車場", hiragana: "ちゅうしゃじょう", meaning: "parking lot" },
                { kanji: "建物", hiragana: "たてもの", meaning: "building" },
                { kanji: "何回も", hiragana: "なんかいも", meaning: "many times; over and over" },
                { kanji: "―目", hiragana: "―め", meaning: "the ―th (used for order: e.g. いちばんめ = first, にばんめ = second, etc.)" }
            ],
            "Lesson 24": [
                { kanji: "呉れます", hiragana: "くれます", dictionary: "くれる", meaning: "to give (to me / my family)" },
                { kanji: "直します", hiragana: "なおします", dictionary: "直す", meaning: "to repair, fix, correct" },
                { kanji: "連れて行きます", hiragana: "つれていきます", dictionary: "連れていく", meaning: "to take (a person) along" },
                { kanji: "連れて来ます", hiragana: "つれてきます", dictionary: "連れてくる", meaning: "to bring (a person) along" },
                { kanji: "送ります", hiragana: "おくります", dictionary: "送る", meaning: "to escort, accompany (a person); also “to send” (letters, parcels, etc.)" },
                { kanji: "紹介します", hiragana: "しょうかいします", dictionary: "紹介する", meaning: "to introduce" },
                { kanji: "案内します", hiragana: "あんないします", dictionary: "案内する", meaning: "to guide, show around, lead the way" },
                { kanji: "説明します", hiragana: "せつめいする", dictionary: "説明する", meaning: "to explain" },
                { kanji: "おじいさん", hiragana: "おじいさん", meaning: "grandfather; old man" },
                { kanji: "おばあさん", hiragana: "おばあさん", meaning: "grandmother; old woman" },
                { kanji: "じゅんび", hiragana: "じゅんび", meaning: "preparation" },
                { kanji: "引っ越し", hiragana: "ひっこし", meaning: "moving (to a new house)" },
                { kanji: "お菓子", hiragana: "おかし", meaning: "sweets; snacks" },
                { kanji: "ホームステイ", hiragana: "ホームステイ", meaning: "homestay (living with a host family)" },
                { kanji: "全部", hiragana: "ぜんぶ", meaning: "all; everything" },
                { kanji: "自分で", hiragana: "じぶんで", meaning: "by oneself; do it yourself" },
                { kanji: "他に", hiragana: "ほかに", meaning: "besides; in addition; other" }
            ],
            "Lesson 25": [
                { kanji: "考えます", hiragana: "かんがえます", dictionary: "考える", meaning: "to think; to consider" },
                { kanji: "着きます", hiragana: "つきます", dictionary: "着く", meaning: "to arrive (at a place)" },
                { kanji: "取ります", hiragana: "とります", dictionary: "取る", meaning: "to grow old; to take" },
                { kanji: "足ります", hiragana: "たります", dictionary: "足りる", meaning: "to be enough; to suffice" },
                { kanji: "億", hiragana: "おく", meaning: "hundred million" },
                { kanji: "田舎", hiragana: "いなか", meaning: "countryside; hometown" },
                { kanji: "チャンス", hiragana: "チャンス", meaning: "chance; opportunity" },
                { kanji: "意味", hiragana: "いみ", meaning: "meaning" },
                { kanji: "転勤", hiragana: "てんきん", meaning: "job transfer" },
                { kanji: "事", hiragana: "こと", meaning: "thing; matter; fact" },
                { kanji: "暇", hiragana: "ひま", meaning: "free time; leisure" },
                { kanji: "もし", hiragana: "もし", meaning: "if ..." },
                { kanji: "もしもし", hiragana: "もしもし", meaning: "hello (on the phone)" },
                { kanji: "お世話になりました", hiragana: "おせわになりました", meaning: "Thank you for everything." },
                { kanji: "頑張ります", hiragana: "がんばります", dictionary: "頑張る", meaning: "I’ll do my best." },
                { kanji: "どうぞお元気で", hiragana: "どうぞおげんきで", meaning: "Please take care of yourself." }
            ]
        };

        // --- DOM Elements ---
        const lessonSelectionSection = document.getElementById('lesson-selection');
        const modeSelectionSection = document.getElementById('mode-selection');
        const settingsScreen = document.getElementById('settings-screen');
        const revisionSection = document.getElementById('revision-section');
        const finishScreen = document.getElementById('finish-screen');
        const lessonCheckboxesContainer = document.getElementById('lesson-checkboxes');
        const startRevisionBtn = document.getElementById('start-revision-btn');
        const customizeBtn = document.getElementById('customize-btn');
        const backFromSettingsBtn = document.getElementById('back-from-settings-btn');
        const manualWordModeBtn = document.getElementById('manual-word-mode-btn');
        const manualMeaningModeBtn = document.getElementById('manual-meaning-mode-btn');
        const timedWordModeBtn = document.getElementById('timed-word-mode-btn');
        const timedMeaningModeBtn = document.getElementById('timed-meaning-mode-btn');
        const backToLessonsBtn = document.getElementById('back-to-lessons-btn');
        const backFromRevisionBtn = document.getElementById('back-from-revision-btn');
        const flashcard = document.getElementById('flashcard');
        const cardFrontText = document.getElementById('card-front-text');
        const cardBackText = document.getElementById('card-back-text');
        const nextWordBtn = document.getElementById('next-word-btn');
        const previousWordBtn = document.getElementById('previous-word-btn');
        const restartBtn = document.getElementById('restart-btn');
        const statusMessage = document.getElementById('status-message');
        const timerDisplay = document.getElementById('timer-display');
        const flipDelayInput = document.getElementById('flip-delay');
        const nextDelayInput = document.getElementById('next-delay');
        const pauseBtn = document.getElementById('pause-btn');

        // New DOM Elements for word count
        const progressDisplay = document.getElementById('progress-display');
        const wordCountDisplay = document.getElementById('word-count-display');

        // --- State Variables ---
        let selectedLessons = [];
        let currentMode = null; // 'manual-word', 'manual-meaning', 'timed-word', 'timed-meaning'
        let shuffledWords = [];
        let currentIndex = 0;
        let nextWordTimer = null;
        let finishTimer = null;
        let isPaused = false;
        let isFlipped = false;
        let timerSecondsLeft = 0;
        let flipDelay = 0;
        let nextDelay = 0;

        // --- Functions ---
        
        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createLessonCheckboxes() {
            const lessonKeys = Object.keys(vocabularyData);

            // Create 'All' checkbox first
            const allContainer = document.createElement('label');
            allContainer.classList.add('checkbox-container');
            allContainer.id = 'all-checkbox-container'; // Add an ID for easy targeting
            
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.name = 'lesson-all';
            allCheckbox.value = 'all';

            const allSpan = document.createElement('span');
            allSpan.textContent = 'All';

            allContainer.appendChild(allCheckbox);
            allContainer.appendChild(allSpan);
            lessonCheckboxesContainer.appendChild(allContainer);

            // Create individual lesson checkboxes
            lessonKeys.forEach(key => {
                const container = document.createElement('label');
                container.classList.add('checkbox-container');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'lesson';
                checkbox.value = key;

                const span = document.createElement('span');
                // レッスン番号のみを取得
                span.textContent = key.split(' ')[1];

                container.appendChild(checkbox);
                container.appendChild(span);
                lessonCheckboxesContainer.appendChild(container);
            });
        }

        function clearTimers() {
            if (nextWordTimer) clearInterval(nextWordTimer);
            if (finishTimer) clearInterval(finishTimer);
        }

        function showLessonSelection() {
            clearTimers();
            isPaused = false;
            pauseBtn.textContent = 'Pause';
            lessonSelectionSection.classList.remove('hidden');
            modeSelectionSection.classList.add('hidden');
            settingsScreen.classList.add('hidden');
            revisionSection.classList.add('hidden');
            finishScreen.classList.add('hidden');
            statusMessage.textContent = '';
            timerDisplay.textContent = '';
        }

        function showModeSelection() {
            lessonSelectionSection.classList.add('hidden');
            modeSelectionSection.classList.remove('hidden');
            settingsScreen.classList.add('hidden');
        }

        function showSettingsScreen() {
            modeSelectionSection.classList.add('hidden');
            settingsScreen.classList.remove('hidden');
        }
        
        function handleStartRevision() {
            selectedLessons = Array.from(document.querySelectorAll('input[name="lesson"]:checked')).map(cb => cb.value);
            
            if (selectedLessons.length === 0) {
                // Should not happen as button is disabled, but for safety
                return;
            }
            
            const wordsToShuffle = selectedLessons.flatMap(lessonKey => vocabularyData[lessonKey]);
            shuffledWords = shuffleArray(wordsToShuffle);

            showModeSelection();
        }

        function startRevision(mode) {
            currentMode = mode;
            modeSelectionSection.classList.add('hidden');
            revisionSection.classList.remove('hidden');
            finishScreen.classList.add('hidden');
            
            if (currentMode.includes('timed')) {
                pauseBtn.classList.remove('hidden');
            } else {
                pauseBtn.classList.add('hidden');
            }

            currentIndex = 0;
            flipDelay = parseInt(flipDelayInput.value) || 3;
            nextDelay = parseInt(nextDelayInput.value) || 2;
            isPaused = false;
            isFlipped = false;
            timerSecondsLeft = flipDelay;
            
            // Set the total word count and initial progress
            wordCountDisplay.textContent = `Total words: ${shuffledWords.length}`;
            displayCurrentCard();
        }
        
        function updateCardDisplay() {
            const currentWord = shuffledWords[currentIndex];
            const isWordFirst = currentMode.includes('word');
            
            const frontText = isWordFirst ? 
                (currentWord.dictionary ? `<span class="text-3xl">${currentWord.kanji}</span><br><span class="text-xl text-gray-400 mt-1">${currentWord.hiragana}</span><br><span class="text-lg text-gray-500 mt-1">(${currentWord.dictionary})</span>` : `<span class="text-3xl">${currentWord.kanji}</span><br><span class="text-xl text-gray-400 mt-1">${currentWord.hiragana}</span>`) : 
                `<span class="text-3xl">${currentWord.meaning}</span>`;
            
            const backText = isWordFirst ? 
                `<span class="text-2xl">${currentWord.meaning}</span>` : 
                (currentWord.dictionary ? `<span class="text-3xl">${currentWord.kanji}</span><br><span class="text-xl text-gray-400 mt-1">${currentWord.hiragana}</span><br><span class="text-lg text-gray-500 mt-1">(${currentWord.dictionary})</span>` : `<span class="text-3xl">${currentWord.kanji}</span><br><span class="text-xl text-gray-400 mt-1">${currentWord.hiragana}</span>`);

            // Update the visible front text immediately
            cardFrontText.innerHTML = frontText;

            // This is the key change to fix the visual bug.
            // We delay updating the back text until we are ready to flip,
            // to prevent the new text from being briefly visible.
            cardBackText.innerHTML = backText;
        }

        function displayCurrentCard() {
            clearTimers();
            
            flashcard.classList.remove('is-flipped');
            
            // Update the progress display
            progressDisplay.textContent = `Word ${currentIndex + 1} of ${shuffledWords.length}`;

            // Wait for the CSS transition to complete before showing the next card.
            // This prevents the new content from flashing prematurely.
            setTimeout(() => {
                statusMessage.textContent = '';
                
                if (currentIndex >= shuffledWords.length) {
                    revisionSection.classList.add('hidden');
                    finishScreen.classList.remove('hidden');
                    let finishTimerCounter = 5;
                    const finishTimerDisplay = document.getElementById('finish-timer');
                    finishTimerDisplay.textContent = `Returning to lessons in ${finishTimerCounter} seconds...`;
                    
                    finishTimer = setInterval(() => {
                        finishTimerCounter--;
                        finishTimerDisplay.textContent = `Returning to lessons in ${finishTimerCounter} seconds...`;
                        if (finishTimerCounter <= 0) {
                            clearInterval(finishTimer);
                            showLessonSelection();
                        }
                    }, 1000);
                    return;
                }

                previousWordBtn.disabled = currentIndex === 0 || currentMode.includes('timed');
                nextWordBtn.disabled = currentMode.includes('timed');

                previousWordBtn.classList.toggle('bg-gray-500', currentMode.includes('timed') || currentIndex === 0);
                previousWordBtn.classList.toggle('hover:bg-gray-400', currentMode.includes('timed') || currentIndex === 0);
                nextWordBtn.classList.toggle('bg-gray-500', currentMode.includes('timed'));
                nextWordBtn.classList.toggle('hover:bg-indigo-600', !currentMode.includes('timed'));
                nextWordBtn.classList.toggle('cursor-not-allowed', currentMode.includes('timed'));
                
                isPaused = false;
                pauseBtn.textContent = 'Pause';
                
                updateCardDisplay();

                if (currentMode.includes('timed')) {
                    isFlipped = false;
                    timerSecondsLeft = flipDelay;
                    timerDisplay.textContent = `Flipping in ${timerSecondsLeft} seconds...`;
                    nextWordTimer = setInterval(() => {
                        if (!isPaused) {
                            timerSecondsLeft--;
                            if (!isFlipped) {
                                timerDisplay.textContent = `Flipping in ${timerSecondsLeft} seconds...`;
                                if (timerSecondsLeft <= 0) {
                                    flashcard.classList.add('is-flipped');
                                    isFlipped = true;
                                    timerSecondsLeft = nextDelay;
                                }
                            } else {
                                timerDisplay.textContent = `Next card in ${timerSecondsLeft} seconds...`;
                                if (timerSecondsLeft <= 0) {
                                    currentIndex++;
                                    displayCurrentCard();
                                }
                            }
                        }
                    }, 1000);
                }
            }, 100);
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseBtn.textContent = 'Resume';
                timerDisplay.textContent = 'Paused';
            } else {
                pauseBtn.textContent = 'Pause';
                if (currentMode.includes('timed')) {
                    if (!isFlipped) {
                        timerDisplay.textContent = `Flipping in ${timerSecondsLeft} seconds...`;
                    } else {
                        timerDisplay.textContent = `Next card in ${timerSecondsLeft} seconds...`;
                    }
                }
            }
        }

        // --- Event Listeners ---
        lessonCheckboxesContainer.addEventListener('change', (event) => {
            const allCheckbox = document.querySelector('input[name="lesson-all"]');
            const lessonCheckboxes = document.querySelectorAll('input[name="lesson"]');
            
            // Handle 'All' checkbox
            if (event.target === allCheckbox) {
                lessonCheckboxes.forEach(cb => {
                    cb.checked = allCheckbox.checked;
                    cb.closest('label').classList.toggle('selected', allCheckbox.checked);
                });
            } else {
                // If any individual lesson is unchecked, uncheck 'All'
                const allChecked = Array.from(lessonCheckboxes).every(cb => cb.checked);
                allCheckbox.checked = allChecked;
            }
            
            // Update the 'selected' class for the clicked checkbox container
            if (event.target.type === 'checkbox') {
                event.target.closest('label').classList.toggle('selected', event.target.checked);
            }
            
            // Update the 'All' checkbox container class based on its state
            allCheckbox.closest('label').classList.toggle('selected', allCheckbox.checked);

            const checkedCount = document.querySelectorAll('input[name="lesson"]:checked').length;
            startRevisionBtn.disabled = checkedCount === 0;
        });


        startRevisionBtn.addEventListener('click', handleStartRevision);
        customizeBtn.addEventListener('click', showSettingsScreen);
        backFromSettingsBtn.addEventListener('click', showModeSelection);

        manualWordModeBtn.addEventListener('click', () => startRevision('manual-word'));
        manualMeaningModeBtn.addEventListener('click', () => startRevision('manual-meaning'));
        timedWordModeBtn.addEventListener('click', () => startRevision('timed-word'));
        timedMeaningModeBtn.addEventListener('click', () => startRevision('timed-meaning'));

        flashcard.addEventListener('click', () => {
            if (!currentMode.includes('timed')) {
                flashcard.classList.toggle('is-flipped');
            }
        });

        backToLessonsBtn.addEventListener('click', showLessonSelection);
        backFromRevisionBtn.addEventListener('click', showLessonSelection);
        
        restartBtn.addEventListener('click', () => {
            clearTimers();
            isPaused = false;
            pauseBtn.textContent = 'Pause';
            
            const wordsToShuffle = selectedLessons.flatMap(lessonKey => vocabularyData[lessonKey]);
            shuffledWords = shuffleArray(wordsToShuffle);
            startRevision(currentMode);
        });

        nextWordBtn.addEventListener('click', () => {
            clearTimers();
            if (currentIndex < shuffledWords.length - 1) {
                currentIndex++;
                displayCurrentCard();
            }
        });

        previousWordBtn.addEventListener('click', () => {
            clearTimers();
            if (currentIndex > 0) {
                currentIndex--;
                displayCurrentCard();
            }
        });
        
        pauseBtn.addEventListener('click', togglePause);

        // Initial setup
        createLessonCheckboxes();
    </script>

</body>
</html>
